# 🧪 Laboratorio 2: Vulnerability Assessment y Scanning Automatizado

## ⏱️ Duración: 20 minutos
## 🎯 Objetivo: Implementar vulnerability scanning usando Azure Security Center y herramientas externas

---

## 📋 Prerrequisitos
- Laboratorio 1 completado exitosamente
- VMs Windows y Linux creadas y ejecutándose
- Acceso a Azure Portal con permisos de Security Center
- Azure CLI autenticado
- PowerShell como Administrador

---

## 🚀 Paso 1: Habilitar Vulnerability Assessment para VMs (8 minutos)

### Configurar Qualys integration en Security Center:

```powershell
# Definir variables
$resourceGroupName = "rg-security-lab-$env:USERNAME"

# Verificar que las VMs están siendo monitoreadas
Write-Host "🔍 Verificando VMs disponibles..." -ForegroundColor Yellow
az vm list --resource-group $resourceGroupName --output table

# Verificar soluciones de vulnerability assessment existentes
Write-Host "`n🔍 Verificando soluciones VA existentes..." -ForegroundColor Yellow
az security va solution list --output table
```

### Configurar Qualys scanner manualmente (si es necesario):

```powershell
# Instalar agente Qualys en VM Windows
Write-Host "`n🔧 Instalando agente Qualys en VM Windows..." -ForegroundColor Yellow
az vm extension set `
    --publisher "Qualys" `
    --name "QualysAgent" `
    --vm-name "vm-windows-test" `
    --resource-group $resourceGroupName

# Instalar agente Qualys en VM Linux
Write-Host "`n🔧 Instalando agente Qualys en VM Linux..." -ForegroundColor Yellow
az vm extension set `
    --publisher "Qualys" `
    --name "QualysAgent" `
    --vm-name "vm-linux-test" `
    --resource-group $resourceGroupName

# Verificar extensiones instaladas
Write-Host "`n🔍 Verificando extensiones instaladas..." -ForegroundColor Yellow
az vm extension list `
    --vm-name vm-windows-test `
    --resource-group $resourceGroupName `
    --output table

az vm extension list `
    --vm-name vm-linux-test `
    --resource-group $resourceGroupName `
    --output table
```

**✅ Verificación:** Debe ver las extensiones QualysAgent instaladas en ambas VMs.

---

## 🐳 Paso 2: Configurar Container Security Assessment (6 minutos)

### Habilitar container registry scanning:

```powershell
# Crear Azure Container Registry
Write-Host "🔧 Creando Azure Container Registry..." -ForegroundColor Yellow
az acr create `
    --resource-group $resourceGroupName `
    --name "acrsecuritytest$env:USERNAME" `
    --sku Basic `
    --location eastus

# Habilitar Defender for Container Registries
Write-Host "`n🔧 Habilitando Defender for Container Registries..." -ForegroundColor Yellow
az security pricing create `
    --name ContainerRegistry `
    --tier Standard

# Verificar configuración
az security pricing list --output table
```

### Crear imagen de testing con vulnerabilidades conocidas:

```powershell
# Crear directorio para container security test
New-Item -ItemType Directory -Path "container-security-test" -Force
Set-Location "container-security-test"

# Crear Dockerfile con imagen base que puede tener vulnerabilidades
$dockerfileContent = @"
FROM node:14-alpine
WORKDIR /app
COPY package.json .
RUN npm install
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
"@

$dockerfileContent | Out-File -FilePath "Dockerfile" -Encoding UTF8

# Crear package.json con dependencias que pueden tener vulnerabilidades
$packageJsonContent = @"
{
  "name": "security-test-app",
  "version": "1.0.0",
  "dependencies": {
    "express": "4.17.1",
    "lodash": "4.17.19"
  },
  "scripts": {
    "start": "node index.js"
  }
}
"@

$packageJsonContent | Out-File -FilePath "package.json" -Encoding UTF8

# Crear aplicación simple
$indexJsContent = @"
const express = require('express');
const app = express();
app.get('/', (req, res) => res.send('Security Test App'));
app.listen(3000, () => console.log('App running on port 3000'));
"@

$indexJsContent | Out-File -FilePath "index.js" -Encoding UTF8

# Build y push la imagen
Write-Host "`n🔧 Construyendo y subiendo imagen de testing..." -ForegroundColor Yellow
az acr build `
    --registry "acrsecuritytest$env:USERNAME" `
    --image security-test:v1.0 `
    .

Write-Host "✅ Imagen de testing creada y subida exitosamente" -ForegroundColor Green
```

**✅ Verificación:** Debe ver la imagen en el Container Registry y el plan de Defender habilitado.

---

## 🔍 Paso 3: Implementar OpenVAS para Scanning Externo (6 minutos)

### Configurar OpenVAS como scanner complementario:

```powershell
# Crear VM para OpenVAS scanner
Write-Host "🔧 Creando VM para OpenVAS scanner..." -ForegroundColor Yellow
az vm create `
    --resource-group $resourceGroupName `
    --name vm-openvas-scanner `
    --image Ubuntu2204 `
    --vnet-name vnet-security-lab `
    --subnet snet-data `
    --size Standard_D2s_v3 `
    --admin-username azureuser `
    --generate-ssh-keys `
    --public-ip-address pip-openvas `
    --nsg nsg-openvas

# Obtener IP pública de la VM OpenVAS
$OPENVAS_IP = az vm show -d `
    --resource-group $resourceGroupName `
    --name vm-openvas-scanner `
    --query publicIps -o tsv

Write-Host "🌐 OpenVAS Scanner IP: $OPENVAS_IP" -ForegroundColor Cyan
```

### Conectar a la VM y configurar OpenVAS:

```powershell
# Crear script de configuración de OpenVAS
$openvasSetupScript = @"
#!/bin/bash
echo "🔧 Configurando OpenVAS en la VM..."

# Actualizar sistema
sudo apt update
sudo apt install -y docker.io docker-compose
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -aG docker azureuser

# Desplegar OpenVAS usando Docker
docker run -d \
  --name openvas \
  -p 443:443 \
  -e PASSWORD=admin123 \
  --volume openvas-data:/data \
  mikesplain/openvas

# Verificar que OpenVAS está ejecutándose
echo "🔍 Verificando estado de OpenVAS..."
docker ps
docker logs openvas

echo "✅ OpenVAS configurado exitosamente"
echo "🌐 URL: https://$OPENVAS_IP"
echo "👤 Username: admin"
echo "🔑 Password: admin123"
"@

$openvasSetupScript | Out-File -FilePath "setup-openvas.sh" -Encoding UTF8

Write-Host "`n📋 Script de configuración de OpenVAS creado: setup-openvas.sh" -ForegroundColor Green
Write-Host "🌐 Para configurar OpenVAS, conectar por SSH a: azureuser@$OPENVAS_IP" -ForegroundColor Cyan
Write-Host "📝 Ejecutar: bash -s < setup-openvas.sh" -ForegroundColor Cyan
```

**✅ Verificación:** Debe poder conectarse por SSH a la VM OpenVAS y ver el contenedor ejecutándose.

---

## 📊 Paso 4: Verificar Configuración Completa (5 minutos)

### Script de verificación final:

```powershell
# Script de verificación completa
$verificationScript = @"
Write-Host "=== VERIFICACIÓN DE VULNERABILITY ASSESSMENT ===" -ForegroundColor Green

# Verificar VMs y extensiones
Write-Host "`n🔍 Verificando VMs y extensiones..." -ForegroundColor Yellow
`$vms = az vm list --resource-group $resourceGroupName --output json | ConvertFrom-Json
foreach (`$vm in `$vms) {
    Write-Host "🔍 Verificando extensiones en `$(`$vm.name)..." -ForegroundColor Yellow
    `$extensions = az vm extension list --vm-name `$(`$vm.name) --resource-group $resourceGroupName --output json | ConvertFrom-Json
    `$qualysExtension = `$extensions | Where-Object { `$_.name -eq "QualysAgent" }
    if (`$qualysExtension) {
        Write-Host "✅ QualysAgent instalado en `$(`$vm.name)" -ForegroundColor Green
    } else {
        Write-Host "❌ QualysAgent NO instalado en `$(`$vm.name)" -ForegroundColor Red
    }
}

# Verificar Container Registry
Write-Host "`n🔍 Verificando Container Registry..." -ForegroundColor Yellow
try {
    `$acr = az acr show --name "acrsecuritytest$env:USERNAME" --resource-group $resourceGroupName --output json | ConvertFrom-Json
    Write-Host "✅ Container Registry: `$(`$acr.name)" -ForegroundColor Green
} catch {
    Write-Host "❌ Container Registry no encontrado" -ForegroundColor Red
}

# Verificar OpenVAS VM
Write-Host "`n🔍 Verificando VM OpenVAS..." -ForegroundColor Yellow
try {
    `$openvasVM = az vm show --name vm-openvas-scanner --resource-group $resourceGroupName --output json | ConvertFrom-Json
    `$openvasIP = az vm show -d --name vm-openvas-scanner --resource-group $resourceGroupName --query publicIps -o tsv
    Write-Host "✅ OpenVAS VM: `$(`$openvasVM.name) - IP: `$openvasIP" -ForegroundColor Green
} catch {
    Write-Host "❌ VM OpenVAS no encontrada" -ForegroundColor Red
}

# Verificar planes de Defender
Write-Host "`n🔍 Verificando planes de Defender..." -ForegroundColor Yellow
`$pricing = az security pricing list --output json | ConvertFrom-Json
`$containerRegistryPlan = `$pricing | Where-Object { `$_.name -eq "ContainerRegistry" }
if (`$containerRegistryPlan -and `$containerRegistryPlan.pricingTier -eq "Standard") {
    Write-Host "✅ Defender for Container Registries habilitado" -ForegroundColor Green
} else {
    Write-Host "❌ Defender for Container Registries NO habilitado" -ForegroundColor Red
}

Write-Host "`n=== VERIFICACIÓN COMPLETADA ===" -ForegroundColor Green
"@

# Guardar y ejecutar script
$verificationScript | Out-File -FilePath "verify-vulnerability-assessment.ps1" -Encoding UTF8
.\verify-vulnerability-assessment.ps1
```

**✅ Verificación Final:** Todos los componentes deben mostrar ✅ verde.

---

## 🎯 Resultados Esperados

Al completar este laboratorio, habrá logrado:

### 🛡️ Vulnerability Assessment:
- ✅ Qualys agents instalados y reportando en VMs
- ✅ Container registry scanning habilitado y funcional
- ✅ OpenVAS scanner operacional y accesible
- ✅ Vulnerability reports generándose automáticamente

### 🐳 Container Security:
- ✅ Azure Container Registry configurado
- ✅ Defender for Container Registries habilitado
- ✅ Imagen de testing con vulnerabilidades conocidas
- ✅ Scanning automatizado de imágenes

### 🔍 External Scanning:
- ✅ VM OpenVAS desplegada y configurada
- ✅ Scanner complementario operacional
- ✅ Capacidad de scanning externo independiente

---

## 🚨 Troubleshooting Común

### Error: "Qualys agent installation failed"
**Solución:**
```powershell
# Verificar que la VM está ejecutándose
az vm get-instance-view `
    --name vm-windows-test `
    --resource-group $resourceGroupName `
    --query instanceView.statuses

# Reintentar instalación manual
az vm extension set `
    --publisher "Qualys" `
    --name "QualysAgent" `
    --vm-name "vm-windows-test" `
    --resource-group $resourceGroupName `
    --force-update
```

### Error: "OpenVAS container not starting"
**Solución:**
```bash
# Conectar por SSH a la VM OpenVAS
ssh azureuser@$OPENVAS_IP

# Verificar logs del container
docker logs openvas

# Verificar puertos disponibles
sudo netstat -tlnp | grep :443

# Reiniciar container si es necesario
docker stop openvas
docker rm openvas
docker run -d --name openvas -p 443:443 -e PASSWORD=admin123 mikesplain/openvas
```

### Error: "Container Registry build failed"
**Solución:**
```powershell
# Verificar que Docker está instalado localmente
docker --version

# Verificar login al ACR
az acr login --name "acrsecuritytest$env:USERNAME"

# Reintentar build
az acr build --registry "acrsecuritytest$env:USERNAME" --image security-test:v1.0 .
```

---

## 📊 Métricas de Éxito

Indicadores de Implementación Exitosa:
- ✅ Vulnerability Assessment: Qualys agents instalados y reportando en VMs
- ✅ Container Security: Container registry scanning habilitado y funcional
- ✅ External Scanning: OpenVAS scanner operacional y accesible
- ✅ Automated Detection: Vulnerability reports generándose automáticamente

---

## 🔗 Recursos Adicionales

- [Azure Security Center Vulnerability Assessment](https://docs.microsoft.com/azure/security-center/deploy-vulnerability-assessment-vm)
- [Container Security in Azure](https://docs.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction)
- [OpenVAS Documentation](https://www.openvas.org/)
- [Qualys Integration Guide](https://docs.microsoft.com/azure/security-center/deploy-vulnerability-assessment-vm#deploy-the-qualys-built-in-vulnerability-scanner)

---

## 🎯 Próximos Pasos

Una vez completado este laboratorio, estará listo para:

1. **Laboratorio 3:** Análisis de Secure Score y Automatización

---

## 📝 Notas Importantes

- **Tiempo de Propagación:** Los agentes de vulnerability assessment pueden tardar hasta 24 horas en reportar resultados
- **Costos:** OpenVAS es gratuito, pero la VM genera costos de Azure
- **Seguridad:** Las credenciales de OpenVAS son para propósitos educativos
- **Limpieza:** Recuerde ejecutar los scripts de limpieza al final de todos los laboratorios

---

## 🧹 Limpieza de Recursos (Opcional)

```powershell
# Deshabilitar Defender plans para evitar costos
az security pricing create --name VirtualMachines --tier Free
az security pricing create --name AppServices --tier Free
az security pricing create --name StorageAccounts --tier Free
az security pricing create --name SqlServers --tier Free
az security pricing create --name ContainerRegistry --tier Free

# Eliminar resource group completo
az group delete --name $resourceGroupName --yes --no-wait

# Limpiar políticas personalizadas
az policy assignment delete --name "assign-https-policy"
az policy assignment delete --name "require-storage-encryption"
az policy definition delete --name "require-https-webapps"
```

---

**✅ ¡Vulnerability Assessment configurado exitosamente! Está listo para el siguiente laboratorio.** 