# ğŸ§ª Laboratorio 2: Vulnerability Assessment y Scanning Automatizado

## â±ï¸ DuraciÃ³n: 20 minutos
## ğŸ¯ Objetivo: Implementar vulnerability scanning usando Azure Security Center y herramientas externas

---

## ğŸ“‹ Prerrequisitos
- Laboratorio 1 completado exitosamente
- VMs Windows y Linux creadas y ejecutÃ¡ndose
- Acceso a Azure Portal con permisos de Security Center
- Azure CLI autenticado
- PowerShell como Administrador

---

## ğŸš€ Paso 1: Habilitar Vulnerability Assessment para VMs (8 minutos)

### Configurar Qualys integration en Security Center:

```powershell
# Definir variables
$resourceGroupName = "rg-security-lab-$env:USERNAME"

# Verificar que las VMs estÃ¡n siendo monitoreadas
Write-Host "ğŸ” Verificando VMs disponibles..." -ForegroundColor Yellow
az vm list --resource-group $resourceGroupName --output table

# Verificar soluciones de vulnerability assessment existentes
Write-Host "`nğŸ” Verificando soluciones VA existentes..." -ForegroundColor Yellow
az security va solution list --output table
```

### Configurar Qualys scanner manualmente (si es necesario):

```powershell
# Instalar agente Qualys en VM Windows
Write-Host "`nğŸ”§ Instalando agente Qualys en VM Windows..." -ForegroundColor Yellow
az vm extension set `
    --publisher "Qualys" `
    --name "QualysAgent" `
    --vm-name "vm-windows-test" `
    --resource-group $resourceGroupName

# Instalar agente Qualys en VM Linux
Write-Host "`nğŸ”§ Instalando agente Qualys en VM Linux..." -ForegroundColor Yellow
az vm extension set `
    --publisher "Qualys" `
    --name "QualysAgent" `
    --vm-name "vm-linux-test" `
    --resource-group $resourceGroupName

# Verificar extensiones instaladas
Write-Host "`nğŸ” Verificando extensiones instaladas..." -ForegroundColor Yellow
az vm extension list `
    --vm-name vm-windows-test `
    --resource-group $resourceGroupName `
    --output table

az vm extension list `
    --vm-name vm-linux-test `
    --resource-group $resourceGroupName `
    --output table
```

**âœ… VerificaciÃ³n:** Debe ver las extensiones QualysAgent instaladas en ambas VMs.

---

## ğŸ³ Paso 2: Configurar Container Security Assessment (6 minutos)

### Habilitar container registry scanning:

```powershell
# Crear Azure Container Registry
Write-Host "ğŸ”§ Creando Azure Container Registry..." -ForegroundColor Yellow
az acr create `
    --resource-group $resourceGroupName `
    --name "acrsecuritytest$env:USERNAME" `
    --sku Basic `
    --location eastus

# Habilitar Defender for Container Registries
Write-Host "`nğŸ”§ Habilitando Defender for Container Registries..." -ForegroundColor Yellow
az security pricing create `
    --name ContainerRegistry `
    --tier Standard

# Verificar configuraciÃ³n
az security pricing list --output table
```

### Crear imagen de testing con vulnerabilidades conocidas:

```powershell
# Crear directorio para container security test
New-Item -ItemType Directory -Path "container-security-test" -Force
Set-Location "container-security-test"

# Crear Dockerfile con imagen base que puede tener vulnerabilidades
$dockerfileContent = @"
FROM node:14-alpine
WORKDIR /app
COPY package.json .
RUN npm install
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
"@

$dockerfileContent | Out-File -FilePath "Dockerfile" -Encoding UTF8

# Crear package.json con dependencias que pueden tener vulnerabilidades
$packageJsonContent = @"
{
  "name": "security-test-app",
  "version": "1.0.0",
  "dependencies": {
    "express": "4.17.1",
    "lodash": "4.17.19"
  },
  "scripts": {
    "start": "node index.js"
  }
}
"@

$packageJsonContent | Out-File -FilePath "package.json" -Encoding UTF8

# Crear aplicaciÃ³n simple
$indexJsContent = @"
const express = require('express');
const app = express();
app.get('/', (req, res) => res.send('Security Test App'));
app.listen(3000, () => console.log('App running on port 3000'));
"@

$indexJsContent | Out-File -FilePath "index.js" -Encoding UTF8

# Build y push la imagen
Write-Host "`nğŸ”§ Construyendo y subiendo imagen de testing..." -ForegroundColor Yellow
az acr build `
    --registry "acrsecuritytest$env:USERNAME" `
    --image security-test:v1.0 `
    .

Write-Host "âœ… Imagen de testing creada y subida exitosamente" -ForegroundColor Green
```

**âœ… VerificaciÃ³n:** Debe ver la imagen en el Container Registry y el plan de Defender habilitado.

---

## ğŸ” Paso 3: Implementar OpenVAS para Scanning Externo (6 minutos)

### Configurar OpenVAS como scanner complementario:

```powershell
# Crear VM para OpenVAS scanner
Write-Host "ğŸ”§ Creando VM para OpenVAS scanner..." -ForegroundColor Yellow
az vm create `
    --resource-group $resourceGroupName `
    --name vm-openvas-scanner `
    --image Ubuntu2204 `
    --vnet-name vnet-security-lab `
    --subnet snet-data `
    --size Standard_D2s_v3 `
    --admin-username azureuser `
    --generate-ssh-keys `
    --public-ip-address pip-openvas `
    --nsg nsg-openvas

# Obtener IP pÃºblica de la VM OpenVAS
$OPENVAS_IP = az vm show -d `
    --resource-group $resourceGroupName `
    --name vm-openvas-scanner `
    --query publicIps -o tsv

Write-Host "ğŸŒ OpenVAS Scanner IP: $OPENVAS_IP" -ForegroundColor Cyan
```

### Conectar a la VM y configurar OpenVAS:

```powershell
# Crear script de configuraciÃ³n de OpenVAS
$openvasSetupScript = @"
#!/bin/bash
echo "ğŸ”§ Configurando OpenVAS en la VM..."

# Actualizar sistema
sudo apt update
sudo apt install -y docker.io docker-compose
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -aG docker azureuser

# Desplegar OpenVAS usando Docker
docker run -d \
  --name openvas \
  -p 443:443 \
  -e PASSWORD=admin123 \
  --volume openvas-data:/data \
  mikesplain/openvas

# Verificar que OpenVAS estÃ¡ ejecutÃ¡ndose
echo "ğŸ” Verificando estado de OpenVAS..."
docker ps
docker logs openvas

echo "âœ… OpenVAS configurado exitosamente"
echo "ğŸŒ URL: https://$OPENVAS_IP"
echo "ğŸ‘¤ Username: admin"
echo "ğŸ”‘ Password: admin123"
"@

$openvasSetupScript | Out-File -FilePath "setup-openvas.sh" -Encoding UTF8

Write-Host "`nğŸ“‹ Script de configuraciÃ³n de OpenVAS creado: setup-openvas.sh" -ForegroundColor Green
Write-Host "ğŸŒ Para configurar OpenVAS, conectar por SSH a: azureuser@$OPENVAS_IP" -ForegroundColor Cyan
Write-Host "ğŸ“ Ejecutar: bash -s < setup-openvas.sh" -ForegroundColor Cyan
```

**âœ… VerificaciÃ³n:** Debe poder conectarse por SSH a la VM OpenVAS y ver el contenedor ejecutÃ¡ndose.

---

## ğŸ“Š Paso 4: Verificar ConfiguraciÃ³n Completa (5 minutos)

### Script de verificaciÃ³n final:

```powershell
# Script de verificaciÃ³n completa
$verificationScript = @"
Write-Host "=== VERIFICACIÃ“N DE VULNERABILITY ASSESSMENT ===" -ForegroundColor Green

# Verificar VMs y extensiones
Write-Host "`nğŸ” Verificando VMs y extensiones..." -ForegroundColor Yellow
`$vms = az vm list --resource-group $resourceGroupName --output json | ConvertFrom-Json
foreach (`$vm in `$vms) {
    Write-Host "ğŸ” Verificando extensiones en `$(`$vm.name)..." -ForegroundColor Yellow
    `$extensions = az vm extension list --vm-name `$(`$vm.name) --resource-group $resourceGroupName --output json | ConvertFrom-Json
    `$qualysExtension = `$extensions | Where-Object { `$_.name -eq "QualysAgent" }
    if (`$qualysExtension) {
        Write-Host "âœ… QualysAgent instalado en `$(`$vm.name)" -ForegroundColor Green
    } else {
        Write-Host "âŒ QualysAgent NO instalado en `$(`$vm.name)" -ForegroundColor Red
    }
}

# Verificar Container Registry
Write-Host "`nğŸ” Verificando Container Registry..." -ForegroundColor Yellow
try {
    `$acr = az acr show --name "acrsecuritytest$env:USERNAME" --resource-group $resourceGroupName --output json | ConvertFrom-Json
    Write-Host "âœ… Container Registry: `$(`$acr.name)" -ForegroundColor Green
} catch {
    Write-Host "âŒ Container Registry no encontrado" -ForegroundColor Red
}

# Verificar OpenVAS VM
Write-Host "`nğŸ” Verificando VM OpenVAS..." -ForegroundColor Yellow
try {
    `$openvasVM = az vm show --name vm-openvas-scanner --resource-group $resourceGroupName --output json | ConvertFrom-Json
    `$openvasIP = az vm show -d --name vm-openvas-scanner --resource-group $resourceGroupName --query publicIps -o tsv
    Write-Host "âœ… OpenVAS VM: `$(`$openvasVM.name) - IP: `$openvasIP" -ForegroundColor Green
} catch {
    Write-Host "âŒ VM OpenVAS no encontrada" -ForegroundColor Red
}

# Verificar planes de Defender
Write-Host "`nğŸ” Verificando planes de Defender..." -ForegroundColor Yellow
`$pricing = az security pricing list --output json | ConvertFrom-Json
`$containerRegistryPlan = `$pricing | Where-Object { `$_.name -eq "ContainerRegistry" }
if (`$containerRegistryPlan -and `$containerRegistryPlan.pricingTier -eq "Standard") {
    Write-Host "âœ… Defender for Container Registries habilitado" -ForegroundColor Green
} else {
    Write-Host "âŒ Defender for Container Registries NO habilitado" -ForegroundColor Red
}

Write-Host "`n=== VERIFICACIÃ“N COMPLETADA ===" -ForegroundColor Green
"@

# Guardar y ejecutar script
$verificationScript | Out-File -FilePath "verify-vulnerability-assessment.ps1" -Encoding UTF8
.\verify-vulnerability-assessment.ps1
```

**âœ… VerificaciÃ³n Final:** Todos los componentes deben mostrar âœ… verde.

---

## ğŸ¯ Resultados Esperados

Al completar este laboratorio, habrÃ¡ logrado:

### ğŸ›¡ï¸ Vulnerability Assessment:
- âœ… Qualys agents instalados y reportando en VMs
- âœ… Container registry scanning habilitado y funcional
- âœ… OpenVAS scanner operacional y accesible
- âœ… Vulnerability reports generÃ¡ndose automÃ¡ticamente

### ğŸ³ Container Security:
- âœ… Azure Container Registry configurado
- âœ… Defender for Container Registries habilitado
- âœ… Imagen de testing con vulnerabilidades conocidas
- âœ… Scanning automatizado de imÃ¡genes

### ğŸ” External Scanning:
- âœ… VM OpenVAS desplegada y configurada
- âœ… Scanner complementario operacional
- âœ… Capacidad de scanning externo independiente

---

## ğŸš¨ Troubleshooting ComÃºn

### Error: "Qualys agent installation failed"
**SoluciÃ³n:**
```powershell
# Verificar que la VM estÃ¡ ejecutÃ¡ndose
az vm get-instance-view `
    --name vm-windows-test `
    --resource-group $resourceGroupName `
    --query instanceView.statuses

# Reintentar instalaciÃ³n manual
az vm extension set `
    --publisher "Qualys" `
    --name "QualysAgent" `
    --vm-name "vm-windows-test" `
    --resource-group $resourceGroupName `
    --force-update
```

### Error: "OpenVAS container not starting"
**SoluciÃ³n:**
```bash
# Conectar por SSH a la VM OpenVAS
ssh azureuser@$OPENVAS_IP

# Verificar logs del container
docker logs openvas

# Verificar puertos disponibles
sudo netstat -tlnp | grep :443

# Reiniciar container si es necesario
docker stop openvas
docker rm openvas
docker run -d --name openvas -p 443:443 -e PASSWORD=admin123 mikesplain/openvas
```

### Error: "Container Registry build failed"
**SoluciÃ³n:**
```powershell
# Verificar que Docker estÃ¡ instalado localmente
docker --version

# Verificar login al ACR
az acr login --name "acrsecuritytest$env:USERNAME"

# Reintentar build
az acr build --registry "acrsecuritytest$env:USERNAME" --image security-test:v1.0 .
```

---

## ğŸ“Š MÃ©tricas de Ã‰xito

Indicadores de ImplementaciÃ³n Exitosa:
- âœ… Vulnerability Assessment: Qualys agents instalados y reportando en VMs
- âœ… Container Security: Container registry scanning habilitado y funcional
- âœ… External Scanning: OpenVAS scanner operacional y accesible
- âœ… Automated Detection: Vulnerability reports generÃ¡ndose automÃ¡ticamente

---

## ğŸ”— Recursos Adicionales

- [Azure Security Center Vulnerability Assessment](https://docs.microsoft.com/azure/security-center/deploy-vulnerability-assessment-vm)
- [Container Security in Azure](https://docs.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction)
- [OpenVAS Documentation](https://www.openvas.org/)
- [Qualys Integration Guide](https://docs.microsoft.com/azure/security-center/deploy-vulnerability-assessment-vm#deploy-the-qualys-built-in-vulnerability-scanner)

---

## ğŸ¯ PrÃ³ximos Pasos

Una vez completado este laboratorio, estarÃ¡ listo para:

1. **Laboratorio 3:** AnÃ¡lisis de Secure Score y AutomatizaciÃ³n

---

## ğŸ“ Notas Importantes

- **Tiempo de PropagaciÃ³n:** Los agentes de vulnerability assessment pueden tardar hasta 24 horas en reportar resultados
- **Costos:** OpenVAS es gratuito, pero la VM genera costos de Azure
- **Seguridad:** Las credenciales de OpenVAS son para propÃ³sitos educativos
- **Limpieza:** Recuerde ejecutar los scripts de limpieza al final de todos los laboratorios

---

## ğŸ§¹ Limpieza de Recursos (Opcional)

```powershell
# Deshabilitar Defender plans para evitar costos
az security pricing create --name VirtualMachines --tier Free
az security pricing create --name AppServices --tier Free
az security pricing create --name StorageAccounts --tier Free
az security pricing create --name SqlServers --tier Free
az security pricing create --name ContainerRegistry --tier Free

# Eliminar resource group completo
az group delete --name $resourceGroupName --yes --no-wait

# Limpiar polÃ­ticas personalizadas
az policy assignment delete --name "assign-https-policy"
az policy assignment delete --name "require-storage-encryption"
az policy definition delete --name "require-https-webapps"
```

---

**âœ… Â¡Vulnerability Assessment configurado exitosamente! EstÃ¡ listo para el siguiente laboratorio.** 